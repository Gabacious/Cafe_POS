<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kapihan ni Boss G POS - User & Settings Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .bg-cafe { background-color: #5d4037 !important; }
        .table thead th { background-color: #e9ecef; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-cafe shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">â˜• Kapihan ni Boss G POS (Admin)</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="navLinks">
                    </ul>
                <a href="login.html" class="btn btn-outline-light" onclick="localStorage.clear()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h3 class="mb-4 text-secondary">User & Settings Management</h3>

        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark fw-bold">Current User Details</div>
            <div class="card-body">
                <p><strong>Username:</strong> <span id="current-user"></span></p>
                <p><strong>Role:</strong> <span id="current-role"></span></p>
                <p class="text-danger">
                    **Note:** Changing your own details requires logging out and logging back in for the changes to take effect.
                </p>
            </div>
        </div>

        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5>Staff Account Management</h5>
                <button class="btn btn-sm btn-success" onclick="openUserModal('new')">Add New Staff</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-list">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card shadow">
            <div class="card-header bg-info text-white">General POS Settings (Placeholder)</div>
            <div class="card-body">
                <p class="text-muted">
                    In a full system, this area would handle crucial business settings like:
                    <ul>
                        <li>Tax Rates (e.g., 12% VAT)</li>
                        <li>Receipt Header/Footer Messages</li>
                        <li>Default Currency (e.g., PHP)</li>
                        <li>Timezone Configuration</li>
                    </ul>
                </p>
                <button class="btn btn-outline-info" onclick="alert('Settings configuration is a backend feature and is simulated here.')">Save Settings</button>
            </div>
        </div>

    </div>

    <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="userModalLabel">Add New Staff Account</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="original-username">
                        
                        <div class="mb-3">
                            <label for="modal-username" class="form-label">Username (Unique)</label>
                            <input type="text" class="form-control" id="modal-username" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modal-password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="modal-password" placeholder="Leave blank to keep current password (Edit mode)">
                        </div>
                        
                        <div class="mb-3">
                            <label for="modal-role" class="form-label">Role</label>
                            <select class="form-select" id="modal-role" required>
                                <option value="Cashier">Cashier</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">Save Account</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let users = {};
        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        
        // --- INITIAL DATA & BOOTSTRAP ---

        // WARNING: In a real app, passwords would be hashed. This is for demo only.
        const defaultUsers = {
            'admin': { username: 'admin', password: 'adminpass', role: 'Admin' },
            'cashier': { username: 'cashier', password: 'cashierpass', role: 'Cashier' },
            'gabe': { username: 'gabe', password: 'gabe123', role: 'Admin' },
            'staff1': { username: 'staff1', password: 'pass123', role: 'Cashier' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAccess();
            loadUsers();
            renderNav();
            renderUserList();
            renderCurrentAdminInfo();
        });
        
        // --- AUTHENTICATION & NAVIGATION ---

        function checkAdminAccess() {
            const userRole = localStorage.getItem('userRole');
            if (userRole !== 'Admin') {
                alert("Access Denied. You must be logged in as an Admin to access User Management.");
                window.location.href = 'login.html';
                return;
            }
        }

        function renderNav() {
            const navLinks = document.getElementById('navLinks');
            navLinks.innerHTML = `
                <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="orders.html">Orders</a></li>
                <li class="nav-item"><a class="nav-link" href="product_management.html">Products</a></li>
                <li class="nav-item"><a class="nav-link" href="reports.html">Reports</a></li>
                <li class="nav-item"><a class="nav-link active" href="user_settings.html">Users & Settings</a></li>
            `;
        }

        function renderCurrentAdminInfo() {
            document.getElementById('current-user').textContent = localStorage.getItem('currentUser') || 'N/A';
            document.getElementById('current-role').textContent = localStorage.getItem('userRole') || 'N/A';
        }
        
        // --- USER DATA MANAGEMENT ---
        
        function loadUsers() {
            const storedUsers = localStorage.getItem('posUsers');
            if (storedUsers) {
                users = JSON.parse(storedUsers);
            } else {
                users = defaultUsers;
                saveUsers();
            }
        }

        function saveUsers() {
            localStorage.setItem('posUsers', JSON.stringify(users));
        }

        function renderUserList() {
            const tbody = document.getElementById('user-list');
            tbody.innerHTML = '';
            
            if (Object.keys(users).length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">No staff accounts found.</td></tr>';
                return;
            }

            for (const username in users) {
                const user = users[username];
                const row = `
                    <tr>
                        <td>${user.username}</td>
                        <td><span class="badge bg-${user.role === 'Admin' ? 'danger' : 'success'}">${user.role}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary me-2" onclick="openUserModal('${user.username}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.username}')">Delete</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            }
        }
        
        // --- CRUD ACTIONS ---

        function openUserModal(username) {
            const isNew = username === 'new';
            const modalTitle = document.getElementById('userModalLabel');
            const form = document.getElementById('userForm');
            form.reset(); 
            
            document.getElementById('original-username').value = isNew ? '' : username;
            document.getElementById('modal-username').readOnly = !isNew;

            if (isNew) {
                modalTitle.textContent = 'Add New Staff Account';
            } else {
                modalTitle.textContent = 'Edit Staff Account';
                const user = users[username];
                if (user) {
                    document.getElementById('modal-username').value = user.username;
                    document.getElementById('modal-role').value = user.role;
                    // Note: Password field is intentionally left blank for security reasons in edit mode
                }
            }
            userModal.show();
        }

        function saveUser() {
            const originalUsername = document.getElementById('original-username').value;
            const isNew = originalUsername === '';
            
            const newUsername = document.getElementById('modal-username').value;
            const newPassword = document.getElementById('modal-password').value;
            const newRole = document.getElementById('modal-role').value;
            
            if (!document.getElementById('userForm').checkValidity() || (!isNew && !newUsername)) {
                alert('Please ensure the username and role are set.');
                return;
            }

            if (isNew) {
                // ADD new user
                if (users[newUsername]) {
                    alert('Username already exists. Please choose a different one.');
                    return;
                }
                if (!newPassword) {
                     alert('New accounts must have a password.');
                    return;
                }
                users[newUsername] = { username: newUsername, password: newPassword, role: newRole };
                alert(`Staff account '${newUsername}' created successfully!`);
                
            } else {
                // EDIT existing user
                const userToUpdate = users[originalUsername];
                
                if (userToUpdate) {
                    // Update password if a new one was provided
                    if (newPassword) {
                        userToUpdate.password = newPassword;
                    }
                    userToUpdate.role = newRole;
                    
                    // If the username was changed (only possible in edit mode if readOnly was removed, which it wasn't here, but as a safeguard)
                    if (originalUsername !== newUsername) {
                        delete users[originalUsername];
                        users[newUsername] = userToUpdate;
                    }
                    
                    alert(`Staff account '${newUsername}' updated successfully!`);
                }
            }

            saveUsers();
            renderUserList();
            userModal.hide();
        }

        function deleteUser(username) {
            const currentAdmin = localStorage.getItem('currentUser');
            
            if (username === currentAdmin) {
                alert(`You cannot delete your own active account (${username}).`);
                return;
            }
            
            if (confirm(`Are you sure you want to delete the account for '${username}'? This action is permanent.`)) {
                delete users[username];
                saveUsers();
                renderUserList();
                alert(`Account '${username}' deleted.`);
            }
        }
    </script>
</body>
</html>